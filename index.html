<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>„Å≤„ÅçÁÆó„Éû„Çπ„Çø„Éº</title>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Á¥ôÂêπÈõ™Áî®„É©„Ç§„Éñ„É©„É™ -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    
    <style>
        /* „Éô„Éº„ÇπË®≠ÂÆöÔºöÁõÆ„Å´ÂÑ™„Åó„ÅÑÁ©∫Ëâ≤„Éª„Éë„Çπ„ÉÜ„É´Ë™ø */
        body { 
            font-family: 'M PLUS Rounded 1c', sans-serif; 
            margin: 0; padding: 0; 
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            min-height: 100vh; overflow: hidden;
            user-select: none; -webkit-tap-highlight-color: transparent;
            display: flex; flex-direction: column;
            color: #475569; /* Slate-600 */
        }
        /* „Ç∞„É©„Çπ„É¢„Éº„Éï„Ç£„Ç∫„É†ÂäπÊûú */
        .glass { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); border: 2px solid rgba(255, 255, 255, 0.8); box-shadow: 0 4px 12px rgba(186, 230, 253, 0.25); }
        .hidden { display: none !important; }
        .btn-active:active { transform: scale(0.96); filter: brightness(0.95); }
        .no-scrollbar::-webkit-scrollbar { display: none; }

        /* „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        @keyframes rockShake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-3px) rotate(-3deg); } 75% { transform: translateX(3px) rotate(3deg); } }
        .animate-shake { animation: rockShake 0.1s linear infinite; }
        
        .rock-fragment { position: absolute; background: #fbbf24; border: 2px solid #b45309; z-index: 50; pointer-events: none; border-radius: 4px; }
        @keyframes fragmentFly { 0% { transform: translate(0, 0) rotate(0deg) scale(1); opacity: 1; } 100% { transform: translate(var(--tx), var(--ty)) rotate(var(--tr)) scale(0.5); opacity: 0; } }
        
        .firework-particle { position: absolute; width: 8px; height: 8px; border-radius: 50%; pointer-events: none; z-index: 100; box-shadow: 0 0 6px currentColor; }
        @keyframes explode { 0% { transform: translate(0, 0) scale(1); opacity: 1; } 100% { transform: translate(var(--dx), var(--dy)) scale(0); opacity: 0; } }
        
        .path-hanamaru { stroke-dasharray: 1500; stroke-dashoffset: 1500; animation: drawHanamaru 2s ease-out forwards; }
        @keyframes drawHanamaru { to { stroke-dashoffset: 0; } }

        /* „ÉÜ„É≥„Ç≠„ÉºÈÖçÁΩÆ */
        .numpad-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; padding-bottom: 4px; max-width: 400px; margin: 0 auto; width: 100%; }
        /* OK„Éú„Çø„É≥ */
        .ok-btn-cell { background: linear-gradient(135deg, #38bdf8, #0284c7); color: white; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 1.5rem; border-radius: 16px; box-shadow: 0 4px 0 #0369a1; border: none; }
        .ok-btn-cell:active { box-shadow: 0 0 0 #0369a1; transform: translateY(4px); }

        .num-btn { background: rgba(255,255,255,0.9); color: #0284c7; border-radius: 16px; font-weight: 800; font-size: 1.5rem; box-shadow: 0 4px 0 rgba(56, 189, 248, 0.2); border: 1px solid rgba(255,255,255,0.8); }
        .num-btn:active { box-shadow: none; transform: translateY(4px); }

        /* Ë™çÂÆöË®º„Çπ„Çø„Ç§„É´ */
        .cert-container { 
            position: relative; 
            width: 100%; 
            max-width: 600px; 
            margin: 0 auto; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); 
            border-radius: 8px; 
            overflow: hidden; 
            user-select: auto; 
        }
        .cert-bg { width: 100%; height: auto; display: block; }
        
        .cert-input {
            position: absolute;
            background: transparent;
            border: 1px dashed rgba(0,0,0,0.0);
            font-family: sans-serif;
            font-weight: bold;
            color: #111;
            padding: 0 2px;
            line-height: 1.1;
            z-index: 10;
        }
        .cert-input:focus { 
            background: rgba(255, 255, 255, 0.9); 
            border: 2px solid #0ea5e9; 
            outline: none; 
            border-radius: 4px;
        }

        /* ÂÜôÁúü„Ç®„É™„Ç¢ */
        .cert-photo-area {
            position: absolute;
            background: #f0f9ff;
            overflow: hidden;
            display: flex; align-items: center; justify-content: center;
            border-radius: 4px;
            border: 2px dashed #bae6fd;
            z-index: 5;
            cursor: pointer;
            transition: all 0.2s;
        }
        .cert-photo-area:hover { border-color: #0ea5e9; background: #e0f2fe; }
        .cert-photo-img { width: 100%; height: 100%; object-fit: cover; }
        .cert-photo-placeholder { text-align: center; color: #0ea5e9; pointer-events: none; }
        
        /* „Éú„Çø„É≥ÁÑ°ÂäπÁä∂ÊÖã */
        .btn-disabled { opacity: 0.5; pointer-events: none; background: #eee !important; color: #aaa !important; border-color: #ddd !important; box-shadow: none !important; }
        
        /* „É¢„Éº„Éâ„Éú„Çø„É≥„Ç¢„ÇØ„ÉÜ„Ç£„Éñ/Èùû„Ç¢„ÇØ„ÉÜ„Ç£„Éñ */
        .mode-btn-active { background: #38bdf8 !important; color: white !important; border-bottom: 2px solid #0284c7 !important; }
        .mode-btn-inactive { color: #0284c7 !important; background: transparent; border-bottom: 2px solid transparent !important; }
        .mode-btn-inactive:hover { background: rgba(255,255,255,0.5); }

        /* „Éñ„É≠„ÉÉ„ÇØ„Éí„É≥„Éà */
        .block-circle { width: 20px; height: 20px; border-radius: 50%; box-shadow: inset 0 -2px 0 rgba(0,0,0,0.2); transition: all 0.3s; position: relative; }
        .block-empty { border: 2px dashed #cbd5e1; background: transparent; box-shadow: none; }
        .block-blue { background-color: #3b82f6; border: 1px solid #1d4ed8; }
        
        /* „Éê„ÉÑÂç∞ÔºàÂºï„Åã„Çå„Çã„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Áî®Ôºâ */
        .block-removed { background-color: #cbd5e1; border: 1px solid #94a3b8; box-shadow: none; }
        .block-removed::after {
            content: ''; position: absolute; top: 50%; left: 50%; width: 80%; height: 2px;
            background: #64748b; transform: translate(-50%, -50%) rotate(45deg);
        }
        .block-removed::before {
            content: ''; position: absolute; top: 50%; left: 50%; width: 80%; height: 2px;
            background: #64748b; transform: translate(-50%, -50%) rotate(-45deg);
        }

        .block-spacer { width: 10px; }

        /* „Éñ„É≠„ÉÉ„ÇØÁ†¥Â£ä„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        @keyframes popOut { 
            0% { transform: scale(1); opacity: 1; } 
            50% { transform: scale(1.5); opacity: 0.5; } 
            100% { transform: scale(2); opacity: 0; } 
        }
        .animate-pop-out { 
            animation: popOut 0.4s ease-out forwards; 
            border-color: transparent !important; 
            background: transparent !important; 
            box-shadow: none !important;
        }

        /* „ÅÇ„Å™„ÅÜ„ÇÅ„É¢„Éº„ÉâÁî®„Çπ„Çø„Ç§„É´ */
        .box-input {
            min-width: 80px; height: 80px;
            border-bottom: 4px solid #93c5fd; /* blue-300 */
            color: #3b82f6; /* blue-500 */
            background: rgba(255, 255, 255, 0.8);
            border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 3rem; font-weight: 900;
            padding-bottom: 4px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
            animation: pulse 2s infinite;
        }
        .box-input.filled {
            border-color: #f43f5e; /* rose-500 */
            color: #e11d48; /* rose-600 */
            animation: none;
        }
        .anaume-active {
            background-color: #f3e8ff !important; /* purple-100 */
            border-color: #a855f7 !important; /* purple-500 */
            color: #7e22ce !important; /* purple-700 */
        }
    </style>
</head>
<body class="p-2 flex justify-center items-center">

    <div id="app-root" class="max-w-md mx-auto w-full h-[100dvh] flex flex-col relative transition-transform pb-2">
        
        <!-- „Çø„Éñ -->
        <div class="flex bg-white/40 backdrop-blur-md rounded-full p-1 mb-2 shadow-sm flex-none h-12 items-center">
            <button id="nav-challenge" onclick="switchTab('challenge')" class="flex-1 h-full rounded-full text-sm font-bold transition-all bg-sky-400 text-white shadow-md flex items-center justify-center gap-1">
                <i data-lucide="zap" class="w-4 h-4"></i> „ÉÅ„É£„É¨„É≥„Ç∏
            </button>
            <button id="nav-record" onclick="switchTab('record')" class="flex-1 h-full rounded-full text-sm font-bold transition-all text-sky-600 flex items-center justify-center gap-1">
                <i data-lucide="book-open" class="w-4 h-4"></i> „Åç„Çç„Åè
            </button>
        </div>

        <!-- ÁîªÈù¢1Ôºö„É°„Éã„É•„Éº -->
        <div id="scr-menu" class="screen glass rounded-3xl p-3 text-center flex-1 flex flex-col justify-start overflow-hidden relative">
            
            <div class="space-y-2 relative flex flex-col h-full">
                <h1 class="text-lg font-black text-sky-500 flex justify-center items-center gap-2 mt-1 drop-shadow-sm flex-none">
                    <i data-lucide="minus-circle" class="w-5 h-5 fill-sky-100"></i> „Å≤„ÅçÁÆó„Éû„Çπ„Çø„Éº
                </h1>

                <!-- ÂêçÂâçÂÖ•Âäõ -->
                <div class="bg-white/60 p-1.5 rounded-xl border border-sky-100 shadow-inner flex-none">
                    <input type="text" id="user-name-input" placeholder="„Åä„Å™„Åæ„Åà (‰æã: 1-1 „Åü„Çç„ÅÜ)" 
                           class="w-full bg-transparent text-center font-bold text-sky-800 placeholder-sky-300 outline-none text-base"
                           oninput="saveName()">
                </div>
                
                <div class="text-left text-xs font-bold text-sky-400 pl-1 flex-none">‚ñº „ÇÇ„Çì„Å†„ÅÑ„Çí„Åà„Çâ„Çì„Åß„Å≠</div>
                
                <!-- ÊÆµ„Éú„Çø„É≥„Ç®„É™„Ç¢ -->
                <div id="dan-buttons-area" class="grid grid-cols-3 gap-2 flex-1 content-start"></div>
                
                <!-- „É¢„Éº„ÉâÂàáÊõøÔºà3ÊäûÔºö„Å™„Åó/„ÅÇ„Çä/„É©„É≥„ÉÄ„É†Ôºâ -->
                <div class="bg-white/50 p-1 rounded-xl border border-white flex-none mt-1">
                    <div class="flex gap-1 items-stretch">
                        <button id="mode-no-carry" class="flex-1 py-2 rounded-lg font-bold text-sm leading-tight transition-all mode-btn-inactive" onclick="setMode('NO_CARRY')">
                            „Åè„Çä‰∏ã„Åå„Çä<br>„Å™„Åó
                        </button>
                        <button id="mode-has-carry" class="flex-1 py-2 rounded-lg font-bold text-sm leading-tight transition-all mode-btn-inactive" onclick="setMode('HAS_CARRY')">
                            „Åè„Çä‰∏ã„Åå„Çä<br>„ÅÇ„Çä
                        </button>
                        <button id="mode-random" class="flex-1 py-2 rounded-lg font-bold text-lg transition-all mode-btn-inactive flex items-center justify-center" onclick="setMode('RANDOM')">
                            „É©„É≥„ÉÄ„É†
                        </button>
                    </div>
                </div>

                <!-- „ÅÇ„Å™„ÅÜ„ÇÅ„É¢„Éº„Éâ„Çπ„Ç§„ÉÉ„ÉÅ -->
                <div class="bg-white/50 p-1.5 rounded-xl border border-white flex-none mt-1">
                    <button id="btn-anaume" onclick="toggleAnaume()" class="w-full py-2 rounded-lg font-bold text-base transition-all flex items-center justify-center gap-2 bg-transparent text-slate-400 border-2 border-slate-200 hover:bg-white/50">
                        <div id="check-anaume" class="w-5 h-5 rounded-md border-2 border-slate-300 flex items-center justify-center transition-colors">
                            <i data-lucide="check" class="w-3 h-3 text-white opacity-0 transition-opacity"></i>
                        </div>
                        <span class="tracking-tight">„ÅÇ„Å™„ÅÜ„ÇÅË®àÁÆó <span class="text-xs font-normal opacity-80">(‚ñ° - 3 = 5)</span></span>
                    </button>
                </div>
                
                <button onclick="startGame('stage')" class="flex-none w-full py-3 bg-gradient-to-r from-sky-400 to-blue-400 text-white rounded-xl font-black text-lg shadow-lg btn-active flex items-center justify-center gap-2 border-b-4 border-blue-500 relative top-0 active:top-[4px] active:border-b-0 transition-all mt-1">
                    <i data-lucide="play" class="w-5 h-5 fill-current"></i> „Çπ„Çø„Éº„ÉàÔºÅ
                </button>

                <!-- „Éã„Ç¨„ÉÜ„Éú„Çø„É≥ÔºàÊù°‰ª∂‰ªò„ÅçË°®Á§∫Ôºâ -->
                <div id="nigate-area" class="hidden flex-none w-full animate-pulse">
                     <button onclick="startGame('nigate')" class="w-full py-2 bg-gradient-to-r from-orange-500 to-red-500 text-white rounded-xl font-black text-base shadow-md btn-active border-b-2 border-red-700 flex items-center justify-center gap-2">
                        <span class="text-xl">üî•</span> „Éã„Ç¨„ÉÜ„Çí„Åì„Åè„Åµ„ÅèÔºÅ <span id="nigate-count" class="text-sm bg-white/20 px-2 rounded-full"></span>
                    </button>
                </div>

                <div class="space-y-1 border-t border-sky-100 pt-2 flex-none">
                    <div class="grid grid-cols-2 gap-2">
                        <button id="btn-sp-15" onclick="startGame('range', '15')" class="py-2 rounded-lg font-bold text-base shadow-sm border border-gray-200 bg-gray-50 text-gray-400 cursor-not-allowed relative h-12 flex items-center justify-center" disabled>
                            <span class="flex items-center gap-1"><i data-lucide="lock" class="w-4 h-4"></i> 1„Äú5 „Åæ„Å®„ÇÅ</span>
                        </button>
                        <button id="btn-sp-69" onclick="startGame('range', '69')" class="py-2 rounded-lg font-bold text-base shadow-sm border border-gray-200 bg-gray-50 text-gray-400 cursor-not-allowed relative h-12 flex items-center justify-center" disabled>
                            <span class="flex items-center gap-1"><i data-lucide="lock" class="w-4 h-4"></i> 6„Äú9 „Åæ„Å®„ÇÅ</span>
                        </button>
                    </div>
                    <div class="relative h-14" id="last-challenge-box">
                        <div id="rock-layer" class="absolute inset-0 z-20 flex items-center justify-center bg-gradient-to-br from-stone-400 to-stone-500 border-b-4 border-stone-600 rounded-lg shadow-lg cursor-pointer transition-transform" onclick="tryCrumble()">
                            <div class="text-stone-100 font-black text-[10px] tracking-widest flex flex-col items-center">
                                <span class="flex items-center gap-1"><i data-lucide="lock" class="w-3 h-3"></i> MASTER SEAL</span>
                            </div>
                        </div>
                        <button id="btn-sp-last" onclick="startGame('last')" class="w-full h-full rounded-lg font-black text-base shadow-md border-2 border-gray-200 bg-gray-100 text-gray-400 cursor-not-allowed relative flex items-center justify-center" disabled>
                            <span class="flex items-center gap-1"><i data-lucide="lock" class="w-4 h-4"></i> „Åú„Çì„Å∂„Å´„Å°„Çá„ÅÜ„Åõ„ÇìÔºÅ</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ÁîªÈù¢2Ôºö„Ç≤„Éº„É†„Éó„É¨„Ç§ -->
        <div id="screen-game" class="screen hidden flex-1 flex flex-col min-h-0 space-y-2 fade-in">
            <!-- „Çø„Ç§„É†„Éê„Éº -->
            <div class="w-full bg-white/50 rounded-full h-3 overflow-hidden shadow-inner p-0.5">
                <div id="time-bar" class="bg-gradient-to-r from-sky-300 to-blue-400 h-full rounded-full transition-all duration-1000 ease-linear" style="width: 100%"></div>
            </div>
            
            <div class="glass rounded-2xl px-4 py-2 flex justify-between items-center flex-none text-blue-500 shadow-sm h-14">
                <div class="flex items-center gap-2">
                    <div class="bg-blue-100 p-1.5 rounded-full"><i data-lucide="timer" class="w-5 h-5"></i></div>
                    <span id="display-timer" class="text-3xl font-mono font-black tracking-tighter">30</span>
                </div>
                <div id="display-count" class="px-3 py-1 bg-white text-sky-500 rounded-full text-xs font-bold border border-sky-100 shadow-sm">„ÅÇ„Å® 10 Âïè</div>
            </div>
            
            <!-- ÂïèÈ°åË°®Á§∫„Ç®„É™„Ç¢ -->
            <div class="glass rounded-3xl flex-1 flex flex-col justify-center items-center text-center shadow-lg relative min-h-0 px-2 py-4 mb-2">
                <div class="absolute top-3 left-0 w-full text-center">
                    <span class="bg-white/80 px-3 py-1 rounded-full text-[10px] text-sky-400 font-bold uppercase tracking-widest border border-sky-100">Question</span>
                </div>
                
                <!-- Êï∞ÂºèË°®Á§∫„Ç®„É™„Ç¢ÔºàÂãïÁöÑ„Å´Êõ∏„ÅçÊèõ„ÅàÔºâ -->
                <div id="formula-area" class="flex items-center justify-center gap-1 w-full mt-4">
                    <!-- ÂàùÊúüÁä∂ÊÖãÔºàJS„Åß‰∏äÊõ∏„Åç„Åï„Çå„Åæ„ÅôÔºâ -->
                    <span class="text-5xl font-black text-slate-600">15 - 7</span>
                    <span class="text-3xl text-sky-200 font-black">Ôºù</span>
                    <div class="min-w-[80px] h-20 border-b-4 border-blue-300 bg-white/80 rounded-xl"></div>
                </div>

                <!-- „Éì„Ç∏„É•„Ç¢„É´„Éí„É≥„Éà„Ç®„É™„Ç¢ -->
                <div class="mt-2 w-full flex flex-col items-center">
                    <button id="btn-hint" onclick="toggleHint()" class="text-xs text-sky-400 font-bold underline decoration-dotted hover:text-sky-600 transition-colors flex items-center gap-1">
                        <i data-lucide="lightbulb" class="w-3 h-3"></i> „Éí„É≥„Éà„Çí„Åø„Çã
                    </button>
                    <div id="hint-area" class="hidden bg-white/50 p-2 rounded-xl border border-sky-100 w-full max-w-[280px] mt-1 transition-all">
                        <!-- „Éñ„É≠„ÉÉ„ÇØÊèèÁîª„Ç®„É™„Ç¢ -->
                        <div id="blocks-container" class="space-y-1 flex flex-col items-center"></div>
                    </div>
                </div>
            </div>

            <!-- „ÉÜ„É≥„Ç≠„Éº (ÈõªË©±ÈÖçÂàó) -->
            <div class="numpad-container flex-none">
                <button class="num-btn h-14" onclick="inputNum(1)">1</button>
                <button class="num-btn h-14" onclick="inputNum(2)">2</button>
                <button class="num-btn h-14" onclick="inputNum(3)">3</button>
                
                <button class="num-btn h-14" onclick="inputNum(4)">4</button>
                <button class="num-btn h-14" onclick="inputNum(5)">5</button>
                <button class="num-btn h-14" onclick="inputNum(6)">6</button>
                
                <button class="num-btn h-14" onclick="inputNum(7)">7</button>
                <button class="num-btn h-14" onclick="inputNum(8)">8</button>
                <button class="num-btn h-14" onclick="inputNum(9)">9</button>
                
                <button class="glass h-14 rounded-2xl flex items-center justify-center bg-blue-50 text-blue-400 active:bg-blue-100 active:scale-95 transition-transform" onclick="deleteNum()">
                    <i data-lucide="delete" class="w-6 h-6"></i>
                </button>
                <button class="num-btn h-14" onclick="inputNum(0)">0</button>
                <button class="ok-btn-cell h-14" onclick="submitAnswer()">OK</button>
            </div>
        </div>

        <!-- ÁîªÈù¢3ÔºöÁµêÊûú -->
        <div id="screen-result" class="screen hidden glass rounded-3xl p-6 text-center flex-1 flex flex-col justify-center items-center relative overflow-hidden fade-in">
            <div id="fireworks-container" class="absolute inset-0 pointer-events-none z-0"></div>
            <div id="hanamaru-area" class="flex justify-center items-center w-full h-48 mb-4 z-10 relative drop-shadow-xl"></div>
            <div class="z-10 relative w-full bg-white/60 p-6 rounded-3xl backdrop-blur-sm border border-white">
                <h2 id="result-msg" class="text-4xl font-black text-sky-500 mb-2 tracking-wider"></h2>
                <p id="result-sub" class="text-sm font-bold text-gray-500 mb-6"></p>
                <button onclick="backToTitle()" class="w-full py-4 rounded-2xl font-black text-lg shadow-xl bg-gradient-to-r from-sky-400 to-blue-400 text-white btn-active flex items-center justify-center gap-2 border-b-4 border-blue-500 active:border-b-0 active:translate-y-1">
                    <i data-lucide="home" class="w-5 h-5"></i> „Çø„Ç§„Éà„É´„Å∏„ÇÇ„Å©„Çã
                </button>
            </div>
        </div>

        <!-- ÁîªÈù¢4ÔºöË®òÈå≤ -->
        <div id="screen-record" class="screen hidden flex-1 flex flex-col min-h-0 space-y-2 fade-in overflow-hidden">
            <div id="master-badge" class="hidden flex-none text-center py-4 bg-gradient-to-br from-yellow-50 to-white rounded-2xl border-2 border-yellow-200 shadow-sm relative overflow-hidden shrink-0">
                <div class="absolute top-0 left-0 w-full h-2 bg-yellow-300"></div>
                <div id="master-svg" class="flex justify-center mb-1 scale-90 h-20 items-center drop-shadow-md"></div>
                <p class="text-yellow-600 font-black text-xl relative z-10 mt-1">üèÜ „Å≤„ÅçÁÆó„Éû„Çπ„Çø„ÉºÂÖçË®±</p>
                <button onclick="startCertFlow()" class="absolute bottom-3 right-3 bg-yellow-400 text-white text-xs font-bold px-4 py-2 rounded-full shadow-lg hover:bg-yellow-500 z-20 cursor-pointer flex items-center gap-1">
                    <i data-lucide="award" class="w-3 h-3"></i> „Å§„Åè„Çã
                </button>
            </div>
            
            <div class="glass p-3 rounded-2xl shadow-sm flex-none">
                <h3 class="text-xs font-black text-sky-700 mb-2 flex items-center gap-2 border-b border-sky-100 pb-1">
                    <i data-lucide="star" class="w-4 h-4 text-yellow-400 fill-current"></i> „Çπ„Éö„Ç∑„É£„É´„ÉÅ„É£„É¨„É≥„Ç∏
                </h3>
                <div class="grid grid-cols-3 gap-2" id="special-badges-grid"></div>
            </div>
            
            <div class="bg-white/60 rounded-2xl p-3 shadow-md border border-white/50 flex-1 min-h-0 flex flex-col">
                <div class="overflow-y-auto flex-1 no-scrollbar">
                    <table class="w-full text-xs text-center border-collapse">
                        <thead class="sticky top-0 bg-white/90 backdrop-blur-sm z-10">
                            <tr class="text-sky-400 border-b border-sky-100">
                                <th class="pb-2 font-bold text-left pl-4">„ÇÇ„Çì„Å†„ÅÑ</th>
                                <th class="pb-2 font-bold text-sm">„Å™„Åó</th>
                                <th class="pb-2 font-bold text-sm">„ÅÇ„Çä</th>
                                <th class="pb-2 font-bold text-sm">„É©„É≥„ÉÄ„É†</th>
                            </tr>
                        </thead>
                        <tbody id="record-tbody" class="text-gray-600"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ÁîªÈù¢5ÔºöË™çÂÆöË®º‰ΩúÊàê -->
        <div id="screen-cert-maker" class="screen hidden glass rounded-xl p-2 text-center flex-1 flex flex-col justify-start overflow-y-auto no-scrollbar relative">
            <h2 class="text-lg font-black text-sky-600 mb-2 flex items-center justify-center gap-2">
                <i data-lucide="award" class="w-5 h-5 text-yellow-500"></i> „ÇÅ„Çì„Åç„Çá„Åó„Çá„ÅÜ
            </h2>
            <p class="text-[10px] text-gray-500 mb-2">ÊñáÂ≠ó„ÇÑÂÜôÁúü„ÅØ„Çø„ÉÉ„Éó„Åó„Å¶„Åã„Åà„Çâ„Çå„Çã„Çà„ÄÇ<br>„Çπ„ÇØ„Ç∑„Éß„Çí„Å®„Å£„Å¶„Å≠ÔºÅ</p>

            <!-- Ë™çÂÆöË®ºÊú¨‰Ωì -->
            <div id="cert-node" class="cert-container relative w-full bg-white rounded shadow-xl overflow-hidden">
                <img src="https://raw.githubusercontent.com/byakusen/hikizan_menkyo3/refs/heads/main/hikizan_menkyo.png" class="cert-bg" alt="Ë™çÂÆöË®ºËÉåÊôØ">
                
                <!-- Â≠¶Ê†°Âêç -->
                <input type="text" id="in-school" value="" placeholder="„Åå„Å£„Åì„ÅÜ" class="cert-input text-center" 
                       style="top: 46%; left: 37.5%; width: 34%;">

                <!-- Â≠¶Âπ¥ -->
                <input type="text" id="in-grade" value="1" class="cert-input text-center" 
                       style="top: 46.0%; left: 79.9%; width: 10%;">

                <!-- Ê∞èÂêç -->
                <input type="text" id="in-name" value="" placeholder="„Åä„Å™„Åæ„Åà" class="cert-input text-center" 
                       style="top: 33.5%; left: 31%; width: 44%;">
                
                <!-- ÂÜôÁúü„Ç®„É™„Ç¢ -->
                <div id="cert-photo" class="cert-photo-area" onclick="document.getElementById('file-input').click()" 
                     style="top: 36.8%; left: 11.2%; width: 18%; height: 42%; border-radius: 8px;">
                    
                    <img id="cert-photo-img" class="w-full h-full object-cover hidden" style="border-radius: 8px;">
                    <div id="cert-photo-placeholder" class="text-center text-sky-300">
                        <i data-lucide="camera" class="w-5 h-5 mx-auto mb-1"></i>
                        <span class="text-[8px] block leading-tight font-bold">„Åó„ÇÉ„Åó„Çì</span>
                    </div>
                </div>
            </div>

            <input type="file" id="file-input" accept="image/*" class="hidden" onchange="loadPhoto(event)">

            <button onclick="switchTab('record')" class="mt-4 py-2 px-6 rounded-full bg-gray-400 text-white font-bold text-xs shadow-md btn-active">
                „ÇÇ„Å©„Çã
            </button>
        </div>

    </div>

    <!-- Èü≥Ê∫ê -->
    <audio id="se-correct" src="https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3"></audio>
    <audio id="se-wrong" src="https://assets.mixkit.co/active_storage/sfx/255/255-preview.mp3"></audio>
    <audio id="se-fanfare" src="https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3"></audio>
    <audio id="se-crumble" src="https://assets.mixkit.co/active_storage/sfx/2658/2658-preview.mp3"></audio>

    <script>
        // 1„ÅÆÊÆµ(-1)„Äú9„ÅÆÊÆµ(-9)
        const STAGES = [1, 2, 3, 4, 5, 6, 7, 8, 9];
        
        let state = {
            dan: 1, 
            mode: 'NO_CARRY', 
            isAnaume: false, // „ÅÇ„Å™„ÅÜ„ÇÅ„É¢„Éº„Éâ„Éï„É©„Ç∞
            gameType: 'stage',
            problems: [], 
            index: 0, 
            inputAns: "", 
            timer: 30, 
            maxTime: 30,
            intervalId: null, 
            currentKey: "", 
            waitingForCrumble: false
        };
        
        // localStorage„Ç≠„Éº („Å≤„ÅçÁÆóÁî®„Å´Â§âÊõ¥)
        const STORAGE_KEY_RECORDS = 'hikizan_records_v1';
        const STORAGE_KEY_NAME = 'hikizan_username';
        const STORAGE_KEY_VIEW = 'hikizan_view_state';
        const STORAGE_KEY_CERT = 'hikizan_cert_info';
        const STORAGE_KEY_NIGATE = 'hikizan_nigate_list';

        let savedRecords = JSON.parse(localStorage.getItem(STORAGE_KEY_RECORDS)) || {};
        let savedName = localStorage.getItem(STORAGE_KEY_NAME) || "";
        let savedNigate = JSON.parse(localStorage.getItem(STORAGE_KEY_NIGATE)) || [];

        window.onload = () => {
            lucide.createIcons();
            document.getElementById('user-name-input').value = savedName;
            
            loadCertInfo();
            renderMenu();
            renderRecords();
            adjustCertFonts();

            window.addEventListener('resize', adjustCertFonts);

            // ÂâçÂõû„ÅÆÁîªÈù¢Áä∂ÊÖãÂæ©Â∏∞
            const lastView = localStorage.getItem(STORAGE_KEY_VIEW);
            if (lastView === 'cert-maker') {
                switchTab('record', false);
                startCertFlow();
            } else if (lastView === 'record') {
                switchTab('record');
            } else {
                switchTab('challenge');
            }

            ['in-name', 'in-school', 'in-grade'].forEach(id => {
                document.getElementById(id).addEventListener('input', saveCertInfo);
            });
        };

        function saveName() {
            const val = document.getElementById('user-name-input').value;
            localStorage.setItem(STORAGE_KEY_NAME, val);
        }

        function adjustCertFonts() {
            const container = document.getElementById('cert-node');
            if (!container) return;
            const w = container.offsetWidth;
            
            document.getElementById('in-name').style.fontSize = (w * 0.04) + 'px';
            document.getElementById('in-school').style.fontSize = (w * 0.035) + 'px';
            document.getElementById('in-grade').style.fontSize = (w * 0.035) + 'px';
        }

        function saveViewState(view) {
            localStorage.setItem(STORAGE_KEY_VIEW, view);
        }

        function saveCertInfo() {
            const info = {
                name: document.getElementById('in-name').value,
                school: document.getElementById('in-school').value,
                grade: document.getElementById('in-grade').value
            };
            localStorage.setItem(STORAGE_KEY_CERT, JSON.stringify(info));
        }

        function loadCertInfo() {
            const infoStr = localStorage.getItem(STORAGE_KEY_CERT);
            const menuName = localStorage.getItem(STORAGE_KEY_NAME) || ""; 
            
            if (infoStr) {
                const info = JSON.parse(infoStr);
                document.getElementById('in-name').value = info.name || menuName;
                document.getElementById('in-school').value = info.school || "";
                document.getElementById('in-grade').value = info.grade || "1";
            } else {
                document.getElementById('in-name').value = menuName;
            }
        }

        function startCertFlow() {
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            document.getElementById('screen-cert-maker').classList.remove('hidden');
            saveViewState('cert-maker');
            adjustCertFonts();
            
            const menuName = document.getElementById('user-name-input').value;
            if (menuName) {
                document.getElementById('in-name').value = menuName;
                saveCertInfo();
            }
        }

        function loadPhoto(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.getElementById('cert-photo-img');
                    img.src = e.target.result;
                    img.classList.remove('hidden');
                    document.getElementById('cert-photo-placeholder').classList.add('hidden');
                };
                reader.readAsDataURL(file);
            }
        }

        function switchTab(tabName, shouldSave = true) {
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            const btnGame = document.getElementById('nav-challenge');
            const btnRec = document.getElementById('nav-record');
            
            btnGame.className = "flex-1 h-full rounded-full text-sm font-bold transition-all text-sky-600 flex items-center justify-center gap-1 hover:bg-white/30";
            btnRec.className = "flex-1 h-full rounded-full text-sm font-bold transition-all text-sky-600 flex items-center justify-center gap-1 hover:bg-white/30";

            if (tabName === 'challenge') {
                document.getElementById('scr-menu').classList.remove('hidden');
                btnGame.className = "flex-1 h-full rounded-full text-sm font-bold transition-all bg-sky-400 text-white shadow-md flex items-center justify-center gap-1";
                if (state.waitingForCrumble) {
                    state.waitingForCrumble = false;
                    checkUnlockAndCrumble();
                } else { renderMenu(); }
            } else {
                document.getElementById('screen-record').classList.remove('hidden');
                renderRecords();
                btnRec.className = "flex-1 h-full rounded-full text-sm font-bold transition-all bg-sky-400 text-white shadow-md flex items-center justify-center gap-1";
            }
            if(shouldSave) saveViewState(tabName);
        }

        function backToTitle() {
            document.querySelectorAll('.confetti').forEach(c => c.remove());
            switchTab('challenge');
            
            document.getElementById('hint-area').classList.add('hidden');
            document.getElementById('btn-hint').innerHTML = `<i data-lucide="lightbulb" class="w-3 h-3"></i> „Éí„É≥„Éà„Çí„Åø„Çã`;
            lucide.createIcons();
        }

        function retryGame() {
            document.querySelectorAll('.confetti').forEach(c => c.remove());
            // Âêå„ÅòË®≠ÂÆö„ÅßÂÜçÈñã
            if (state.gameType === 'stage') {
                startGame('stage');
            } else if (state.gameType === 'range') {
                const rangeVal = state.currentKey.includes('15') ? '15' : '69';
                startGame('range', rangeVal);
            } else if (state.gameType === 'last') {
                startGame('last');
            } else if (state.gameType === 'nigate') {
                startGame('nigate');
            }
        }

        function setMode(mode) {
            state.mode = mode;
            updateModeButtons();
        }

        function updateModeButtons() {
            const btnNo = document.getElementById('mode-no-carry');
            const btnHas = document.getElementById('mode-has-carry');
            const btnRnd = document.getElementById('mode-random');

            const common = "flex-1 py-2 rounded-lg font-bold transition-all";
            const smallText = "text-sm leading-tight";
            const largeText = "text-lg";

            let clsNo = `${common} ${smallText}`;
            if (state.mode === 'NO_CARRY') clsNo += " mode-btn-active";
            else clsNo += " mode-btn-inactive";
            btnNo.className = clsNo;

            let clsHas = `${common} ${smallText}`;
            if (state.mode === 'HAS_CARRY') clsHas += " mode-btn-active";
            else clsHas += " mode-btn-inactive";
            btnHas.className = clsHas;

            let clsRnd = `${common} ${largeText} flex items-center justify-center`;
            if (state.mode === 'RANDOM') clsRnd += " mode-btn-active";
            else clsRnd += " mode-btn-inactive";
            btnRnd.className = clsRnd;
        }

        function setDan(dan) {
            state.dan = dan;
            renderMenu();
            updateModeButtons();
        }

        function renderMenu() {
            const container = document.getElementById('dan-buttons-area');
            container.innerHTML = "";
            STAGES.forEach(d => {
                const btn = document.createElement('button');
                // „Å≤„ÅçÁÆóË°®Ë®òÔºö „Äá - 1
                btn.innerHTML = `<span class="text-xl font-black tracking-tight">„ÄáÔºç${d}</span>`;
                
                if (state.dan === d) {
                    btn.className = "h-16 rounded-2xl border-2 border-sky-300 bg-sky-400 text-white shadow-md transform scale-105 transition-all flex items-center justify-center";
                } else {
                    btn.className = "h-16 rounded-2xl border border-sky-100 bg-white/70 text-sky-800 hover:bg-white/90 transition-all flex items-center justify-center shadow-sm";
                }
                btn.onclick = () => setDan(d);
                container.appendChild(btn);
            });
            
            const is15Clear = [1,2,3,4,5].every(d => savedRecords[`stage-${d}-RANDOM`]);
            const is69Clear = [6,7,8,9].every(d => savedRecords[`stage-${d}-RANDOM`]);
            
            const isLastClear = savedRecords['range-15'] && savedRecords['range-69'];
            
            updateSpBtn('btn-sp-15', is15Clear, '1„Äú5 „Åæ„Å®„ÇÅ');
            updateSpBtn('btn-sp-69', is69Clear, '6„Äú9 „Åæ„Å®„ÇÅ');
            
            const lastBtn = document.getElementById('btn-sp-last');
            const rock = document.getElementById('rock-layer');
            if (isLastClear && !state.waitingForCrumble) {
                lastBtn.disabled = false;
                lastBtn.className = "w-full h-full rounded-lg font-black text-base shadow-md bg-gradient-to-r from-yellow-300 to-orange-400 text-white btn-active relative z-30 flex items-center justify-center gap-2";
                lastBtn.innerHTML = `<i data-lucide="crown" class="w-4 h-4 fill-white"></i> „Åú„Çì„Å∂„Å´„Å°„Çá„ÅÜ„Åõ„ÇìÔºÅ`;
                if(rock) rock.classList.add('hidden');
            } else {
                lastBtn.disabled = true;
                if(rock) rock.classList.remove('hidden');
            }
            
            const nigateArea = document.getElementById('nigate-area');
            if (savedNigate.length > 0) {
                nigateArea.classList.remove('hidden');
                document.getElementById('nigate-count').innerText = `„ÅÇ„Å® ${savedNigate.length} Âïè`;
            } else {
                nigateArea.classList.add('hidden');
            }
            
            lucide.createIcons();
            updateModeButtons();
        }

        // --- „ÅÇ„Å™„ÅÜ„ÇÅ„É¢„Éº„ÉâÂàáÊõø ---
        function toggleAnaume() {
            state.isAnaume = !state.isAnaume;
            updateAnaumeButton();
        }

        function updateAnaumeButton() {
            const btn = document.getElementById('btn-anaume');
            const check = document.getElementById('check-anaume');
            const icon = check.querySelector('i');

            if (state.isAnaume) {
                btn.className = "w-full py-2 rounded-lg font-bold text-base transition-all flex items-center justify-center gap-2 bg-purple-50 text-purple-600 border-2 border-purple-400 shadow-inner";
                check.className = "w-5 h-5 rounded-md bg-purple-500 border-2 border-purple-500 flex items-center justify-center transition-colors";
                icon.classList.remove('opacity-0');
            } else {
                btn.className = "w-full py-2 rounded-lg font-bold text-base transition-all flex items-center justify-center gap-2 bg-transparent text-slate-400 border-2 border-slate-200 hover:bg-white/50";
                check.className = "w-5 h-5 rounded-md border-2 border-slate-300 flex items-center justify-center transition-colors";
                icon.classList.add('opacity-0');
            }
        }

        function updateSpBtn(id, unlocked, text) {
            const btn = document.getElementById(id);
            if (unlocked) {
                btn.disabled = false;
                btn.className = "py-2 rounded-lg font-bold text-base shadow-md border-b-2 border-sky-500 bg-sky-300 text-white btn-active relative h-12 flex items-center justify-center";
                btn.innerHTML = `<span class="flex items-center gap-1"><i data-lucide="star" class="w-4 h-4 fill-yellow-200 text-yellow-200"></i> ${text}</span>`;
            } else {
                btn.disabled = true;
                btn.className = "py-2 rounded-lg font-bold text-base shadow-sm border border-gray-200 bg-gray-50 text-gray-400 cursor-not-allowed relative h-12 flex items-center justify-center";
                btn.innerHTML = `<span class="flex items-center gap-1"><i data-lucide="lock" class="w-4 h-4"></i> ${text}</span>`;
            }
        }

        // --- „Éí„É≥„ÉàÊ©üËÉΩ ---
        function toggleHint() {
            const area = document.getElementById('hint-area');
            const btn = document.getElementById('btn-hint');
            if (area.classList.contains('hidden')) {
                area.classList.remove('hidden');
                btn.innerHTML = `<i data-lucide="lightbulb-off" class="w-3 h-3"></i> „Éí„É≥„Éà„Çí„Åã„Åè„Åô`;
                renderBlocks();
            } else {
                area.classList.add('hidden');
                btn.innerHTML = `<i data-lucide="lightbulb" class="w-3 h-3"></i> „Éí„É≥„Éà„Çí„Åø„Çã`;
            }
            lucide.createIcons();
        }

        function renderBlocks() {
            const p = state.problems[state.index];
            const parts = p.q.split('-');
            const minuend = parseInt(parts[0].trim()); // Âºï„Åã„Çå„ÇãÊï∞ (ÂÖ®„Éñ„É≠„ÉÉ„ÇØÊï∞)
            const subtrahend = parseInt(parts[1].trim()); // Âºï„ÅèÊï∞ (Ê∂à„Åô„Éñ„É≠„ÉÉ„ÇØÊï∞)
            
            const container = document.getElementById('blocks-container');
            container.innerHTML = '';
            
            // 1ÊÆµÁõÆ (10ÂÄãÊû†)
            const row1 = document.createElement('div');
            row1.className = "flex gap-1 justify-center bg-white/60 p-1.5 rounded-lg border border-sky-50";
            
            // 2ÊÆµÁõÆ (10ÂÄãÊû†) - 10„ÇíË∂Ö„Åà„ÇãÂ†¥Âêà„ÅÆ„Åø
            const row2 = document.createElement('div');
            row2.className = "flex gap-1 justify-center bg-white/60 p-1.5 rounded-lg border border-sky-50 mt-1";
            
            // „Éò„É´„Éë„ÉºÔºöÊû†‰ΩúÊàê
            const createSlots = (row) => {
                for(let i=0; i<10; i++) {
                    const slot = document.createElement('div');
                    slot.className = "block-circle block-empty";
                    if (i === 5) {
                        const sp = document.createElement('div');
                        sp.className = "block-spacer";
                        row.appendChild(sp);
                    }
                    row.appendChild(slot);
                }
            };
            createSlots(row1);
            if (minuend > 10) createSlots(row2);

            const slots1 = row1.querySelectorAll('.block-circle');
            const slots2 = minuend > 10 ? row2.querySelectorAll('.block-circle') : [];

            if (minuend <= 10) {
                // 10‰ª•‰∏ã„ÅÆÂ†¥ÂêàÔºö1ÊÆµÁõÆ„Å´ÈÖçÁΩÆ„Åó„Å¶Âæå„Çç„Åã„ÇâÊ∂à„ÅôÔºàÈÄöÂ∏∏ÈÄö„ÇäÔºâ
                for(let i=0; i<minuend; i++) {
                    slots1[i].className = "block-circle block-blue";
                }
                for(let i=0; i<subtrahend; i++) {
                    const targetIdx = minuend - 1 - i;
                    if(slots1[targetIdx]) {
                        slots1[targetIdx].className = "block-circle block-removed";
                    }
                }
            } else {
                // 10„ÇíË∂Ö„Åà„ÇãÂ†¥ÂêàÔºàÊ∏õÂä†Ê≥ïÔºö10„Åã„ÇâÂºï„ÅèÔºâ
                // 1ÊÆµÁõÆ„ÅØÊ∫ÄÊùØ(10ÂÄã)
                for(let i=0; i<10; i++) {
                    slots1[i].className = "block-circle block-blue";
                }
                // 2ÊÆµÁõÆ„ÅØÁ´ØÊï∞
                const remainder = minuend - 10;
                for(let i=0; i<remainder; i++) {
                    if(slots2[i]) slots2[i].className = "block-circle block-blue";
                }

                // Ê∂à„ÅôÂá¶ÁêÜÔºö1ÊÆµÁõÆÔºà10„ÅÆ„Åæ„Å®„Åæ„ÇäÔºâ„Åã„ÇâÂºï„Åè
                // 1ÊÆµÁõÆ„ÅÆÂæå„Çç„Åã„Çâ subtrahend ÂÄã„ÇíÊ∂à„Åô
                for(let i=0; i<subtrahend; i++) {
                    const targetIdx = 9 - i; // 1ÊÆµÁõÆ„ÅÆÊúÄÂæå(9)„Åã„ÇâÊâãÂâç„Å∏
                    if(slots1[targetIdx]) {
                        slots1[targetIdx].className = "block-circle block-removed";
                    }
                }
            }
            
            container.appendChild(row1);
            if (minuend > 10) container.appendChild(row2);
        }

        // --- ÂïèÈ°åÁîüÊàê„É≠„Ç∏„ÉÉ„ÇØ („Å≤„ÅçÁÆó) ---
        function startGame(type, val) {
            state.gameType = type;
            state.inputAns = "";
            
            document.getElementById('hint-area').classList.add('hidden');
            document.getElementById('btn-hint').innerHTML = `<i data-lucide="lightbulb" class="w-3 h-3"></i> „Éí„É≥„Éà„Çí„Åø„Çã`;
            
            let time = 30;
            let list = [];
            let key = "";
            
            if (type === 'stage') {
                // ÈÄöÂ∏∏„Çπ„ÉÜ„Éº„Ç∏: 10Âïè
                const d = state.dan;
                list = generateProblemsWithCount(d, state.mode, 10);
                key = `stage-${d}-${state.mode}`;
                time = 30;

            } else if (type === 'range') {
                // „Åæ„Å®„ÇÅ: 20Âïè
                const range = val === '15' ? [1,2,3,4,5] : [6,7,8,9];
                list = generateRandomProblemsFromRange(range, 20);
                time = 60;
                key = `range-${val}`;

            } else if (type === 'last') {
                // ÂÖ®Âïè: 30Âïè
                const range = [1,2,3,4,5,6,7,8,9];
                list = generateRandomProblemsFromRange(range, 30);
                time = 90;
                key = `last-challenge`;
            } else if (type === 'nigate') {
                list = shuffleArray([...savedNigate]).slice(0, 10);
                time = 60;
                key = 'nigate-training';
            }
            
            if (list.length === 0) list = [{q: "1 - 1", a: 0, type: 'normal'}]; 

            state.problems = list;
            state.index = 0;
            state.timer = time;
            state.maxTime = time;
            state.currentKey = key;
            
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            document.getElementById('screen-game').classList.remove('hidden');
            updateDisplay();
            
            if (state.intervalId) clearInterval(state.intervalId);
            state.intervalId = setInterval(() => {
                state.timer--;
                const timerEl = document.getElementById('display-timer');
                const barEl = document.getElementById('time-bar');
                timerEl.innerText = state.timer;
                
                const pct = (state.timer / state.maxTime) * 100;
                barEl.style.width = pct + '%';
                
                if (state.timer <= 10) {
                    timerEl.classList.add('text-orange-600');
                    barEl.className = 'h-full rounded-full transition-all duration-1000 ease-linear bg-orange-500';
                } else {
                    timerEl.classList.remove('text-orange-600');
                    barEl.className = 'h-full rounded-full transition-all duration-1000 ease-linear bg-gradient-to-r from-sky-300 to-blue-400';
                }
                
                if (state.timer <= 0) finishGame(false);
            }, 1000);
            
            lucide.createIcons();
        }

        // „Å≤„ÅçÁÆóÂïèÈ°åÁîüÊàê
        function generateProblemsWithCount(dan, mode, count) {
            let candidates = [];
            for (let ans = 0; ans <= 9; ans++) {
                const minuend = dan + ans;
                const onesDigit = minuend % 10;
                const isCarry = (minuend >= 10 && onesDigit < dan);
                
                // Âü∫Êú¨„Éá„Éº„Çø‰ΩúÊàê
                const baseProb = { qStr: `${minuend} - ${dan}`, minuend, subtrahend: dan, ans };

                if (mode === 'RANDOM') {
                    candidates.push(baseProb);
                } else if (mode === 'NO_CARRY' && !isCarry) {
                    candidates.push(baseProb);
                } else if (mode === 'HAS_CARRY' && isCarry) {
                    candidates.push(baseProb);
                }
            }
            
            if (candidates.length === 0) {
                 for (let ans = 0; ans <= 9; ans++) {
                     candidates.push({ qStr: `${dan+ans} - ${dan}`, minuend: dan+ans, subtrahend: dan, ans });
                 }
            }

            let result = [];
            for(let i=0; i<count; i++) {
                let r;
                let maxRetry = 10;
                do {
                    r = candidates[Math.floor(Math.random() * candidates.length)];
                    maxRetry--;
                } while (state.mode === 'RANDOM' && result.length > 0 && result[result.length-1].qStr === r.qStr && maxRetry > 0 && candidates.length > 1);
                
                // „ÅÇ„Å™„ÅÜ„ÇÅ„ÅãÈÄöÂ∏∏„Åã„ÇíÊ±∫ÂÆö„Åó„Å¶„Éï„Ç©„Éº„Éû„ÉÉ„Éà
                result.push(formatProblem(r));
            }
            return result;
        }

        function generateRandomProblemsFromRange(danList, count) {
            let candidates = [];
            danList.forEach(d => {
                for (let ans = 0; ans <= 9; ans++) {
                    const minuend = d + ans;
                    candidates.push({ qStr: `${minuend} - ${d}`, minuend, subtrahend: d, ans });
                }
            });

            let result = [];
            for(let i=0; i<count; i++) {
                let r;
                let maxRetry = 10;
                do {
                    r = candidates[Math.floor(Math.random() * candidates.length)];
                    maxRetry--;
                } while (result.length > 0 && result[result.length-1].qStr === r.qStr && maxRetry > 0);
                result.push(formatProblem(r));
            }
            return result;
        }

        // ÂïèÈ°å„Éá„Éº„Çø„ÇíÊï¥ÂΩ¢ÔºàÈÄöÂ∏∏ or „ÅÇ„Å™„ÅÜ„ÇÅÔºâ
        function formatProblem(base) {
            // base: { qStr, minuend, subtrahend, ans }
            // isAnaume„ÅåON„Å™„Çâ„ÄÅ„É©„É≥„ÉÄ„É†„Å´„Çø„Ç§„Éó„ÇíÊ±∫ÂÆö
            // type: 'normal' (15-7=?), 'fill_min' (?-7=8), 'fill_sub' (15-?=8)
            
            let type = 'normal';
            let correct = base.ans;

            if (state.isAnaume) {
                // 0: fill_min, 1: fill_sub
                const r = Math.random() < 0.5 ? 'fill_min' : 'fill_sub';
                type = r;
                if (r === 'fill_min') correct = base.minuend; // ? - 7 = 8 -> ?=15
                else correct = base.subtrahend; // 15 - ? = 8 -> ?=7
            }

            // q„Éó„É≠„Éë„ÉÜ„Ç£„ÅØÂæåÊñπ‰∫íÊèõÔºà„Éí„É≥„ÉàÊ©üËÉΩ„Å™„Å©„Åß‰Ωø„ÅÜÊñáÂ≠óÂàóË°®ÁèæÔºâ
            // „Åü„Å†„Åó„Éí„É≥„ÉàÊ©üËÉΩ„ÅØ minuend - subtrahend „ÅÆÊßãÈÄ†„ÅåÂøÖË¶Å„Å™„ÅÆ„Åß qStr „Çí‰Ωø„ÅÜ
            return {
                q: base.qStr, // "15 - 7" („Éí„É≥„ÉàË°®Á§∫Áî®)
                a: correct,
                type: type,
                minuend: base.minuend,
                subtrahend: base.subtrahend,
                ansVal: base.ans
            };
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function updateDisplay() {
            const p = state.problems[state.index];
            const area = document.getElementById('formula-area');
            
            // ÂïèÈ°å„Çø„Ç§„Éó„Å´Âøú„Åò„Å¶HTMLÁîüÊàê
            let html = '';
            const boxInput = `<div class="box-input ${state.inputAns ? 'filled' : ''}">${state.inputAns || '?'}</div>`;
            const eq = `<span class="text-3xl sm:text-4xl text-sky-200 shrink-0 font-black">Ôºù</span>`;
            const numCls = "text-5xl sm:text-6xl font-black text-slate-600 shrink-0";
            const op = `<span class="text-3xl sm:text-4xl text-sky-200 shrink-0 font-black">Ôºç</span>`;

            if (p.type === 'normal') {
                // 15 - 7 = ?
                html = `<span class="${numCls}">${p.minuend} - ${p.subtrahend}</span> ${eq} ${boxInput}`;
            } else if (p.type === 'fill_min') {
                // ? - 7 = 8
                html = `${boxInput} ${op} <span class="${numCls}">${p.subtrahend}</span> ${eq} <span class="${numCls}">${p.ansVal}</span>`;
            } else if (p.type === 'fill_sub') {
                // 15 - ? = 8
                html = `<span class="${numCls}">${p.minuend}</span> ${op} ${boxInput} ${eq} <span class="${numCls}">${p.ansVal}</span>`;
            }

            area.innerHTML = html;
            
            // „Éí„É≥„ÉàË°®Á§∫Ôºà„ÅÇ„Å™„ÅÜ„ÇÅ„É¢„Éº„Éâ„Åß„ÇÇ„Éí„É≥„Éà„ÅØË¶ã„Çâ„Çå„Çã„Çà„ÅÜ„Å´„Åô„Çã„Åå„ÄÅ‰ªïÁµÑ„Åø„ÅØ„ÄåÂÖÉ„ÅÆÂºè„Äç„Å´Âü∫„Å•„ÅèÔºâ
            // 15 - ? = 8 „Åß„ÇÇ„ÄÅ15ÂÄã„Åã„Çâ7ÂÄãÂºï„Åë„Å∞8„Å´„Å™„ÇãÂõ≥„ÇíË¶ã„Åõ„Çã„ÅÆ„ÅØÊúâÂäπ
            const hintArea = document.getElementById('hint-area');
            if (!hintArea.classList.contains('hidden')) {
                renderBlocks();
            }
            
            document.getElementById('display-count').innerText = `„ÅÇ„Å® ${state.problems.length - state.index} Âïè`;
        }

        function inputNum(num) {
            // „ÅÇ„Å™„ÅÜ„ÇÅ„É¢„Éº„Éâ„Å™„Çâ2Ê°Å„Åæ„ÅßË®±ÂèØ„ÄÅÈÄöÂ∏∏„ÅØ1Ê°Å
            const maxLen = state.isAnaume ? 2 : 1;
            if (state.inputAns.length >= maxLen) return; 
            state.inputAns += num.toString();
            updateDisplay();
        }

        function deleteNum() {
            state.inputAns = state.inputAns.slice(0, -1);
            updateDisplay();
        }

        function submitAnswer() {
            if (state.inputAns === "") return;
            
            const p = state.problems[state.index];
            const ans = parseInt(state.inputAns);
            
            if (ans === p.a) {
                playAudio('se-correct');
                
                // „Éí„É≥„ÉàË°®Á§∫‰∏≠„Å™„ÇâÁ†¥Â£äÊºîÂá∫„ÇíÂÖ•„Çå„Çã
                const hintArea = document.getElementById('hint-area');
                if (!hintArea.classList.contains('hidden')) {
                    // „Éê„ÉÑÂç∞„ÅÆ„Éñ„É≠„ÉÉ„ÇØÔºàÂºï„ÅèÊï∞Ôºâ„ÇíÂºæ„Åë„Åï„Åõ„Çã
                    const removed = document.querySelectorAll('.block-removed');
                    removed.forEach((el, i) => {
                        setTimeout(() => {
                            el.classList.add('animate-pop-out');
                        }, i * 60); // Â∞ë„Åó„Åö„Å§„Åö„Çâ„Åó„Å¶Âºæ„Åë„Çã
                    });

                    // ÊÆã„Çä„ÅÆ„Éñ„É≠„ÉÉ„ÇØÔºàÁ≠î„ÅàÔºâ„ÇíÂ∞ë„ÅóË∑≥„Å≠„Åï„Åõ„Å¶Âº∑Ë™ø
                    const blues = document.querySelectorAll('.block-blue');
                    blues.forEach(el => {
                        el.animate([
                            { transform: 'scale(1)' },
                            { transform: 'scale(1.2)' },
                            { transform: 'scale(1)' }
                        ], { duration: 300, delay: 200 });
                    });

                    // ÊºîÂá∫„ÅåÁµÇ„Çè„Çã„ÅÆ„ÇíÂæÖ„Å£„Å¶„Åã„ÇâÊ¨°„Å∏ÔºàÊï∞„Å´Âøú„Åò„Å¶ÂæÖ„Å°ÊôÇÈñì„ÇíË™øÊï¥Ôºâ
                    const waitTime = 600 + (removed.length * 60);
                    setTimeout(() => {
                        proceedNext(p);
                    }, waitTime);

                } else {
                    // „Éí„É≥„Éà„Å™„Åó„Å™„ÇâÂç≥Ê¨°„Å∏
                    proceedNext(p);
                }
            } else {
                playAudio('se-wrong');
                if (state.gameType !== 'nigate') {
                    addToNigate(p);
                }
                finishGame(false);
            }
        }

        function proceedNext(p) {
            if (state.gameType === 'nigate') {
                removeFromNigate(p);
            }

            state.index++;
            state.inputAns = "";
            if (state.index >= state.problems.length) finishGame(true);
            else {
                document.getElementById('hint-area').classList.add('hidden');
                document.getElementById('btn-hint').innerHTML = `<i data-lucide="lightbulb" class="w-3 h-3"></i> „Éí„É≥„Éà„Çí„Åø„Çã`;
                lucide.createIcons();
                updateDisplay();
            }
        }
        
        function addToNigate(prob) {
            const exists = savedNigate.some(p => p.q === prob.q);
            if (!exists) {
                savedNigate.push(prob);
                if (savedNigate.length > 100) savedNigate.shift();
                localStorage.setItem(STORAGE_KEY_NIGATE, JSON.stringify(savedNigate));
            }
        }
        
        function removeFromNigate(prob) {
            savedNigate = savedNigate.filter(p => p.q !== prob.q);
            localStorage.setItem(STORAGE_KEY_NIGATE, JSON.stringify(savedNigate));
        }

        function finishGame(isWin) {
            clearInterval(state.intervalId);
            const resScreen = document.getElementById('screen-result');
            const msg = document.getElementById('result-msg');
            const sub = document.getElementById('result-sub');
            const svgBox = document.getElementById('hanamaru-area');
            
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            resScreen.classList.remove('hidden');
            
            if (isWin) {
                if (state.gameType === 'nigate') {
                    if (savedNigate.length === 0) {
                        msg.innerText = "„Éã„Ç¨„ÉÜ„Åì„Åè„Åµ„ÅèÔºÅ";
                        sub.innerText = "„Åú„Çì„Å∂„ÇØ„É™„Ç¢„Åó„Åü„ÇàÔºÅ„Åô„Åî„ÅÑÔºÅ";
                    } else {
                        msg.innerText = "„Å®„Å£„Åè„Çì„ÇØ„É™„Ç¢ÔºÅ";
                        sub.innerText = `„ÅÆ„Åì„Çä ${savedNigate.length} „ÇÇ„ÇìÔºÅ„Åå„Çì„Å∞„ÇåÔºÅ`;
                    }
                    svgBox.innerHTML = createHanamaruSVG(200, "Âä™ÂäõË≥û");
                    launchFireworks();
                } else {
                    msg.innerText = "„ÇØ„É™„Ç¢ÔºÅ";
                    msg.className = "text-5xl font-black text-sky-500 mb-2 drop-shadow-sm";
                    sub.innerText = "„Åô„Åî„ÅÑÔºÅ„Åú„Çì„ÇÇ„Çì„Åõ„ÅÑ„Åã„ÅÑÔºÅ";
                    
                    const wasLocked = !(savedRecords['range-15'] && savedRecords['range-69']);
                    savedRecords[state.currentKey] = true;
                    localStorage.setItem(STORAGE_KEY_RECORDS, JSON.stringify(savedRecords));
                    
                    const isNowUnlocked = savedRecords['range-15'] && savedRecords['range-69'];
                    if (wasLocked && isNowUnlocked) {
                        state.waitingForCrumble = true;
                    }
                    
                    const lbl = (state.currentKey === 'last-challenge') ? "ÂÖçË®±ÁöÜ‰ºù" : "„Åî„ÅÜ„Åã„Åè";
                    svgBox.innerHTML = createHanamaruSVG(200, lbl);
                    
                    if (state.currentKey === 'last-challenge') {
                        playAudio('se-fanfare');
                        launchFireworks(); 
                    } else {
                        confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
                    }
                }
            } else {
                msg.innerText = "„Åä„Åó„Åæ„ÅÑ";
                msg.className = "text-4xl font-black text-slate-500 mb-2";
                sub.innerText = "„Åæ„Å°„Åå„Åà„Å°„ÇÉ„Å£„Åü... „ÇÇ„ÅÜ„ÅÑ„Å°„Å©ÔºÅ";
                svgBox.innerHTML = `<div class="bg-gray-100 p-8 rounded-full shadow-inner"><i data-lucide="x-circle" class="w-20 h-20 text-gray-300"></i></div>`;
                lucide.createIcons();
            }
        }

        function playAudio(id) {
            const a = document.getElementById(id);
            a.currentTime = 0;
            a.play().catch(()=>{});
        }

        function createHanamaruSVG(size, label) {
            return `
            <svg width="${size}" height="${size}" viewBox="0 0 200 200" class="drop-shadow-lg">
                <path class="path-hanamaru" d="M100,20 C110,5 140,5 150,25 C175,20 195,40 190,65 C210,75 210,105 190,115 C195,140 175,160 150,155 C140,180 110,180 100,160 C90,180 60,180 50,155 C25,160 5,140 10,115 C-10,105 -10,75 10,65 C5,40 25,20 50,25 C60,5 90,5 100,20" fill="none" stroke="#38bdf8" stroke-width="8" stroke-linecap="round" stroke-linejoin="round"/>
                <circle class="path-hanamaru" cx="100" cy="90" r="55" fill="none" stroke="#38bdf8" stroke-width="5" />
                <text x="100" y="102" text-anchor="middle" fill="#38bdf8" font-weight="900" font-size="28" style="font-family: 'M PLUS Rounded 1c'">${label}</text>
            </svg>`;
        }

        function renderRecords() {
            const badgeGrid = document.getElementById('special-badges-grid');
            badgeGrid.innerHTML = "";
            [['range-15', '1„Äú5„Åæ„Å®„ÇÅ'], ['range-69', '6„Äú9„Åæ„Å®„ÇÅ'], ['last-challenge', 'ÂÖ®ÂïèÂà∂Ë¶á']].forEach(([k, n]) => {
                const ok = savedRecords[k];
                const d = document.createElement('div');
                d.className = `p-2 rounded-xl flex flex-col items-center justify-center gap-1 ${ok ? 'bg-yellow-100 text-yellow-600 border-2 border-yellow-200 shadow-sm' : 'bg-gray-50 text-gray-300 border border-gray-200'}`;
                d.innerHTML = `<i data-lucide="trophy" class="w-6 h-6 ${ok?'fill-yellow-400 text-yellow-500':''}"></i><span class="text-[10px] font-bold leading-tight">${n}</span>`;
                badgeGrid.appendChild(d);
            });

            const tbody = document.getElementById('record-tbody');
            tbody.innerHTML = "";
            for(let d=1; d<=9; d++){
                const tr = document.createElement('tr');
                tr.className = "border-b border-sky-50 hover:bg-sky-50/50 transition-colors";
                let h = `<td class="text-left pl-4 font-bold text-sky-900 py-1 text-base">„ÄáÔºç${d}</td>`;
                ['NO_CARRY', 'HAS_CARRY', 'RANDOM'].forEach(m => {
                    const ok = savedRecords[`stage-${d}-${m}`];
                    // ÁîüÊàê‰∏çÂèØËÉΩ„Å™ÁµÑ„ÅøÂêà„Çè„ÅõÔºà‰æãÔºö1„ÅÆÊÆµ„Åß„Åè„Çä‰∏ã„Åå„Çä„ÅÇ„ÇäÔºù10-1=9 „Åó„Åã„Å™„ÅÑ„Åå„ÄÅ„Åì„Çå„ÅØÂÆöÁæ©‰∏äÊ¨°„ÅØ„Å™„ÅÑÔºâ
                    // 10-1„Çí„Äå„Åè„Çä‰∏ã„Åå„Çä„Äç„Å®„Åø„Å™„Åô„Åã„ÅØÊµÅÊ¥æ„Åå„ÅÇ„Çã„Åå„ÄÅ„Åì„Åì„Åß„ÅØ„Ç≥„Éº„ÉâÈÄö„ÇäÂà§ÂÆö
                    // 9„ÅÆÊÆµ„Åß„Åè„Çä‰∏ã„Åå„Çä„Å™„Åó (9-9=0) „Å™„Å©„ÅØ‰∏ÄÂøúÂèØËÉΩ
                    
                    h += `<td class="text-center"><div class="w-6 h-6 mx-auto rounded-full flex items-center justify-center ${ok ? 'bg-sky-400 text-white shadow-sm' : 'bg-gray-100'}"><i data-lucide="check" class="w-4 h-4 ${ok?'':'hidden'}"></i></div></td>`;
                });
                tr.innerHTML = h;
                tbody.appendChild(tr);
            }

            if(savedRecords['last-challenge']) {
                document.getElementById('master-badge').classList.remove('hidden');
                document.getElementById('master-svg').innerHTML = createHanamaruSVG(120, "Á•û");
            }
            lucide.createIcons();
        }

        function checkUnlockAndCrumble() {
            const rock = document.getElementById('rock-layer');
            if (!rock) return;
            const is15 = [1,2,3,4,5].every(d => savedRecords[`stage-${d}-RANDOM`]);
            const is69 = [6,7,8,9].every(d => savedRecords[`stage-${d}-RANDOM`]);
            const isUnlocked = is15 && is69;
            
            if (isUnlocked && !rock.classList.contains('hidden')) {
                rock.classList.add('animate-shake');
                playAudio('se-crumble'); 
                
                setTimeout(() => {
                    createRockFragments(rock);
                    rock.classList.add('hidden');
                    const btn = document.getElementById('btn-sp-last');
                    btn.disabled = false;
                    btn.className = "w-full h-full rounded-lg font-black text-base shadow-xl bg-gradient-to-r from-yellow-300 to-orange-400 text-white btn-active relative z-30 animate-pulse flex items-center justify-center gap-2";
                    btn.innerHTML = `<i data-lucide="crown" class="w-5 h-5 fill-white"></i> „Åú„Çì„Å∂„Å´„Å°„Çá„ÅÜ„Åõ„ÇìÔºÅ`;
                    lucide.createIcons();
                }, 800);
            }
        }

        function createRockFragments(rockElem) {
            const container = document.getElementById('last-challenge-box');
            
            for (let i = 0; i < 20; i++) {
                const fragment = document.createElement('div');
                fragment.className = 'rock-fragment';
                const size = Math.random() * 20 + 10;
                fragment.style.width = size + 'px';
                fragment.style.height = size + 'px';
                fragment.style.left = '50%';
                fragment.style.top = '50%';
                const angle = Math.random() * Math.PI * 2;
                const dist = Math.random() * 150 + 50;
                const tx = Math.cos(angle) * dist + 'px';
                const ty = Math.sin(angle) * dist + 'px';
                const tr = (Math.random() - 0.5) * 720 + 'deg';
                fragment.style.setProperty('--tx', tx);
                fragment.style.setProperty('--ty', ty);
                fragment.style.setProperty('--tr', tr);
                fragment.style.animation = 'fragmentFly 1s ease-out forwards';
                container.appendChild(fragment);
                setTimeout(() => fragment.remove(), 1000);
            }
        }

        function launchFireworks() {
            const container = document.getElementById('fireworks-container');
            container.innerHTML = '';
            const colors = ['#38bdf8', '#fbbf24', '#f43f5e', '#10b981', '#a855f7'];
            confetti({ particleCount: 200, spread: 100, origin: { y: 0.6 } });

            for(let i=0; i<15; i++) {
                setTimeout(() => {
                    const cx = Math.random() * 80 + 10;
                    const cy = Math.random() * 50 + 10;
                    const color = colors[Math.floor(Math.random() * colors.length)];
                    for(let j=0; j<20; j++) {
                        const p = document.createElement('div');
                        p.className = 'firework-particle';
                        p.style.backgroundColor = color;
                        p.style.left = cx + '%'; p.style.top = cy + '%';
                        const angle = (j / 20) * 360;
                        const dist = Math.random() * 120 + 60;
                        const dx = Math.cos(angle * Math.PI / 180) * dist + 'px';
                        const dy = Math.sin(angle * Math.PI / 180) * dist + 'px';
                        p.style.setProperty('--dx', dx);
                        p.style.setProperty('--dy', dy);
                        p.style.animation = 'explode 1s ease-out forwards';
                        container.appendChild(p);
                        setTimeout(() => p.remove(), 1000);
                    }
                }, i * 300);
            }
        }
    </script>
</body>
</html>